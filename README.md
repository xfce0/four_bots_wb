# Wildberries Logistics Bot

Комбинированный Telegram бот для работы с Wildberries Logistics, объединяющий функциональность мониторинга остатков ПМ и отгрузок.

## Функциональность

Бот объединяет три основные функции:

1. **Остатки ПМ** - мониторинг остатков на пунктах маршрута:
   - Получение текстовых отчетов по остаткам
   - Выгрузка Excel-отчетов
   - Настройка автоматической отправки отчетов
   - Добавление и управление информацией о маршрутах

2. **Отгрузки** - мониторинг процесса отгрузки товаров:
   - Отслеживание отгрузок в реальном времени
   - Обновление прогресса по каждой отгрузке
   - Уведомления о новых отгрузках
   - Управление мониторингом по разным аккаунтам

3. **Удержания** - мониторинг возможных удержаний:
   - Отслеживание потерянных тар
   - Расчет таймеров до автоматического удержания (120 часов)
   - Получение информации о водителях
   - Уведомления о критических сроках

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd combined_bot
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

3. Создайте файл `.env` на основе `.env.example`:
   ```bash
   cp .env.example .env
   ```

4. Отредактируйте файл `.env`, добавив все необходимые токены и настройки.

## Настройка .env

В файле `.env` необходимо указать следующие настройки:

```
# Telegram Bot Configuration
BOT_TOKEN=ваш_токен_бота

# Telegram Group/Channel Configuration
GROUP_ID=-100000000000
CHANNEL_ID=-100000000000
LIVE_TOPIC_ID=1
COMPLETED_TOPIC_ID=2

# Ostatki PM Configuration
REPORT_INTERVAL_MINUTES=10

# Shipment Monitoring Configuration
CHECK_INTERVAL=10
REFRESH_INTERVAL=60
INACTIVITY_TIMEOUT=300

# Account Configuration
ACCOUNT1_NAME="Имя аккаунта 1"
ACCOUNT1=токен_для_остатки_пм
ACCOUNT1_TOKEN=токен_для_отгрузки
ACCOUNT1_OFFICE_ID=123456
ACCOUNT1_SUPPLIER_ID=1234567
```

## Запуск бота

```bash
python main.py
```

## Использование

После запуска бота отправьте команду `/start` для начала работы.
Вы увидите главное меню с тремя основными режимами:

- **Остатки ПМ** - режим для работы с отчетами по остаткам
- **Отгрузки** - режим для мониторинга отгрузок
- **Удержания** - режим для мониторинга возможных удержаний

Выберите нужный режим, используя кнопки.
В каждом режиме доступно свое меню с соответствующими функциями.

## Команды

- `/start` - Запуск бота / главное меню
- `/monitor` - Запуск мониторинга отгрузок для всех аккаунтов
- `/stop` - Остановка мониторинга отгрузок
- `/status` - Показать текущий статус мониторинга отгрузок
- `/retentions` - Открыть меню мониторинга удержаний
- `/add_route account_id route_id parking shk_norm [fuel_norm]` - Добавить информацию о маршруте

## Структура проекта

```
combined_bot/
├── main.py                    # Основной файл бота
├── utils/                     # Утилиты
│   ├── __init__.py
│   ├── config.py              # Настройки и управление аккаунтами
│   └── message_util.py        # Утилиты для работы с сообщениями
│
├── ostatki/                   # Модуль "Остатки ПМ"
│   ├── __init__.py
│   ├── api.py                 # API клиент для Остатки ПМ
│   ├── data.py                # Управление данными о маршрутах
│   ├── formatter.py           # Форматирование отчетов
│   └── router.py              # Обработчики команд и колбэков
│
├── shipment/                  # Модуль "Отгрузки"
│   ├── __init__.py
│   ├── api.py                 # API клиент для Отгрузок
│   ├── utils.py               # Утилиты для работы с отгрузками
│   ├── monitor.py             # Логика мониторинга отгрузок
│   └── router.py              # Обработчики команд и колбэков
│
└── retentions/                # Модуль "Удержания"
    ├── __init__.py
    ├── api.py                 # API клиент для удержаний
    ├── formatter.py           # Форматирование отчетов об удержаниях
    └── router.py              # Обработчики команд и колбэков
```

## Требования

- Python 3.8+
- Все зависимости указаны в файле `requirements.txt`